# ğŸ¤– Bot WhatsApp - Agendamento com Google Calendar

Bot inteligente para agendamento automÃ¡tico via WhatsApp integrado ao Google Calendar e Firebase.

## ğŸ¯ Funcionalidades

âœ… Agendamento conversacional via WhatsApp  
âœ… VerificaÃ§Ã£o de disponibilidade em tempo real  
âœ… ValidaÃ§Ã£o de horÃ¡rio comercial  
âœ… Cancelamento de agendamentos  
âœ… Timeout automÃ¡tico de conversas  
âœ… Suporte a fuso horÃ¡rio  
âœ… PersistÃªncia de dados no Firebase  

---

## ğŸ“‹ PrÃ©-requisitos

- Node.js 18+ instalado
- Conta Google (para Calendar)
- Projeto Firebase criado
- Celular com WhatsApp

---

## ğŸš€ InstalaÃ§Ã£o Passo a Passo

### 1ï¸âƒ£ Clone e Instale DependÃªncias

```bash
git clone <seu-repositorio>
cd calendario-bot-firebase
npm install
```

### 2ï¸âƒ£ Configure o Firebase

1. Acesse: https://console.firebase.google.com
2. Crie um novo projeto
3. VÃ¡ em **ConfiguraÃ§Ãµes > Contas de ServiÃ§o**
4. Clique em **Gerar nova chave privada**
5. Renomeie o arquivo para `serviceAccountKey.json`
6. **Coloque na RAIZ do projeto** (mesmo nÃ­vel do package.json)

### 3ï¸âƒ£ Configure o Google Calendar API

1. Acesse: https://console.cloud.google.com
2. Crie um novo projeto ou selecione existente
3. Ative a **Google Calendar API**
4. VÃ¡ em **Credenciais > Criar Credenciais > ID do Cliente OAuth**
5. Escolha **Aplicativo da Web**
6. Em **URIs de redirecionamento autorizados**, adicione:
   ```
   http://localhost:3000/oauth2callback
   ```
7. Copie o **Client ID** e **Client Secret**

### 4ï¸âƒ£ Configure as VariÃ¡veis de Ambiente

1. Copie o arquivo exemplo:
```bash
cp .env.example .env
```

2. Edite o `.env` com seus dados:

```bash
# Google Calendar
GOOGLE_CLIENT_ID=seu-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=seu-client-secret
GOOGLE_REDIRECT_URL=http://localhost:3000/oauth2callback

# Empresa
COMPANY_ID=minha_barbearia
COMPANY_NAME=Minha Barbearia

# HorÃ¡rio de Funcionamento
BUSINESS_HOURS_START=09:00
BUSINESS_HOURS_END=18:00
CLOSED_DAYS=0,1  # 0=Domingo, 1=Segunda

# ConfiguraÃ§Ãµes
APPOINTMENT_DURATION_MINUTES=60
CONVERSATION_TIMEOUT_MINUTES=10
TIMEZONE=America/Sao_Paulo
```

### 5ï¸âƒ£ Autentique com Google

```bash
npm run auth
```

Abra no navegador: http://localhost:3000/auth

âš ï¸ **Se der erro "Refresh Token nÃ£o recebido":**
1. Acesse: https://myaccount.google.com/permissions
2. Remova a permissÃ£o do seu aplicativo
3. Tente novamente

### 6ï¸âƒ£ Inicie o Bot

```bash
npm start
```

Escaneie o QR Code com WhatsApp â†’ **Vincular Dispositivo**

---

## ğŸ“± Como Usar

### Cliente conversa assim:

```
Cliente: Oi
Bot: OlÃ¡! Para qual dia vocÃª gostaria de agendar?

Cliente: AmanhÃ£
Bot: Perfeito! Qual horÃ¡rio vocÃª prefere?

Cliente: 14:00
Bot: âœ… Agendamento Confirmado!
     ğŸ“… 28/11/2024
     â° 14:00
```

### Comandos Especiais:

- `cancelar` - Reinicia a conversa
- `cancelar agendamento` - Remove Ãºltimo agendamento
- `agendar` - Inicia novo agendamento

---

## ğŸ—‚ï¸ Estrutura do Projeto (Corrigida)

```
projeto/
â”œâ”€â”€ auth_server.js              âœ… MOVIDO PARA RAIZ
â”œâ”€â”€ serviceAccountKey.json      â† Colocar aqui
â”œâ”€â”€ .env                        â† Suas configuraÃ§Ãµes
â”œâ”€â”€ package.json
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ firebase.js             âœ… Path corrigido
â”‚   â””â”€â”€ googleClient.js         âœ… TransaÃ§Ãµes + cancelamento
â””â”€â”€ src/
    â”œâ”€â”€ bot.js                  âœ… ValidaÃ§Ãµes + timeout
    â””â”€â”€ utils/
        â””â”€â”€ dateHelper.js       âœ… Fuso horÃ¡rio + validaÃ§Ãµes
```

---

## ğŸ”§ Principais CorreÃ§Ãµes

### âœ… CorreÃ§Ã£o 1: Path do Firebase
```javascript
// âŒ Antes (errado)
'../../serviceAccountKey.json'

// âœ… Depois (correto)
'../serviceAccountKey.json'
```

### âœ… CorreÃ§Ã£o 2: ValidaÃ§Ã£o de HorÃ¡rio
```javascript
// Agora valida:
- Formato (HH:MM)
- Range (00:00 - 23:59)
- HorÃ¡rio comercial
- Dias fechados
```

### âœ… CorreÃ§Ã£o 3: Fuso HorÃ¡rio DinÃ¢mico
```javascript
// Usa date-fns-tz para conversÃ£o correta
const startISO = zonedTimeToUtc(localDateTime, TIMEZONE);
```

### âœ… CorreÃ§Ã£o 4: Race Condition nos Tokens
```javascript
// Usa transaÃ§Ã£o do Firestore
await db.runTransaction(async (transaction) => {
  transaction.update(docRef, { googleToken: newToken });
});
```

### âœ… CorreÃ§Ã£o 5: Timeout de Conversa
```javascript
// Reseta automaticamente apÃ³s 10 minutos de inatividade
if (timeSinceLastMessage > CONVERSATION_TIMEOUT) {
  resetConversation();
}
```

---

## ğŸ› Troubleshooting

### Erro: "serviceAccountKey.json nÃ£o encontrado"
- âœ… Verifique se o arquivo estÃ¡ na **raiz** do projeto
- âœ… Confirme o nome exato: `serviceAccountKey.json`

### Erro: "Conta Google nÃ£o conectada"
- âœ… Rode `npm run auth` primeiro
- âœ… Verifique se o Firebase salvou os tokens

### Bot nÃ£o responde
- âœ… Verifique se escaneou o QR Code
- âœ… Confirme que o celular tem internet
- âœ… Veja logs no terminal com `npm start`

### "Refresh Token nÃ£o recebido"
- âœ… Remova permissÃµes em: https://myaccount.google.com/permissions
- âœ… Rode `npm run auth` novamente

---

## ğŸ“Š Dados Salvos no Firebase

### Collection: `companies`
```javascript
{
  name: "Minha Barbearia",
  googleRefreshToken: "xxx",
  googleToken: "xxx",
  lastTokenUpdate: timestamp
}
```

### Collection: `contacts`
```javascript
{
  phoneNumber: "55123456789@c.us",
  name: "JoÃ£o Silva",
  conversationStage: "IDLE",
  lastMessageAt: timestamp,
  lastAppointment: timestamp
}
```

### Collection: `appointments`
```javascript
{
  userId: "55123456789",
  customerName: "JoÃ£o Silva",
  date: "2024-11-28",
  time: "14:00",
  startISO: "2024-11-28T14:00:00-03:00",
  eventId: "xxx",
  status: "confirmed",
  createdAt: timestamp
}
```

---

## ğŸ” SeguranÃ§a

âš ï¸ **NUNCA COMMITE:**
- `.env` (adicione ao `.gitignore`)
- `serviceAccountKey.json`
- `.wwebjs_auth/` (dados do WhatsApp)

Adicione ao `.gitignore`:
```
.env
serviceAccountKey.json
.wwebjs_auth/
node_modules/
```

---

## ğŸ“ LicenÃ§a

MIT

---

## ğŸ†˜ Suporte

DÃºvidas? Abra uma issue no GitHub ou entre em contato.

**Desenvolvido com â¤ï¸ para automatizar agendamentos**